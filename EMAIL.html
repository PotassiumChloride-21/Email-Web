<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>é‚®ä»¶å‘é€å·¥å…·</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
    }
    
    .content {
      padding: 30px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    
    @media (max-width: 768px) {
      .content {
        grid-template-columns: 1fr;
      }
    }
    
    .form-section, .templates-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 10px;
      border: 1px solid #e9ecef;
    }
    
    h2 {
      color: #667eea;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #495057;
    }
    
    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    textarea {
      min-height: 150px;
      resize: vertical;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      flex: 1;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .status {
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    
    .template-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid #e9ecef;
      transition: transform 0.3s;
    }
    
    .template-item:hover {
      transform: translateX(5px);
      border-color: #667eea;
    }
    
    .template-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .template-name {
      font-weight: bold;
      color: #667eea;
    }
    
    .template-actions {
      display: flex;
      gap: 5px;
    }
    
    .template-btn {
      padding: 4px 8px;
      font-size: 12px;
    }
    
    .no-templates {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 20px;
    }
    
    .email-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }
    
    .email-item {
      background: white;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
    }
    
    /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
    .file-item {
      background: white;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 4px solid #28a745;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    #attachments {
      padding: 8px;
      border: 2px dashed #6c757d;
      border-radius: 8px;
      background: #f8f9fa;
      cursor: pointer;
    }
    
    .progress-container {
      margin-top: 15px;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 5px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s;
    }
    
    .progress-text {
      text-align: center;
      font-size: 12px;
      color: #6c757d;
    }
    
    .auth-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .auth-warning a {
      color: #0056b3;
      text-decoration: underline;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“§ é‚®ä»¶å‘é€å·¥å…·</h1>
      <p>å‘é€é‚®ä»¶å¹¶æ”¯æŒé™„ä»¶ä¸Šä¼ åŠŸèƒ½</p>
    </div>
    
    <div id="authWarning" class="auth-warning" style="display: none;"></div>
    
    <div class="content">
      <div class="form-section">
        <h2>æ’°å†™æ–°é‚®ä»¶</h2>
        <form id="emailForm">
          <div class="form-group">
            <label for="recipient">æ”¶ä»¶äººé‚®ç®±ï¼š</label>
            <input type="email" id="recipient" required placeholder="example@gmail.com">
          </div>
          
          <div class="form-group">
            <label for="subject">é‚®ä»¶ä¸»é¢˜ï¼š</label>
            <input type="text" id="subject" required placeholder="é‚®ä»¶ä¸»é¢˜">
          </div>
          
          <div class="form-group">
            <label for="body">é‚®ä»¶å†…å®¹ï¼š</label>
            <textarea id="body" required placeholder="è¯·è¾“å…¥é‚®ä»¶å†…å®¹..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="attachments">é™„ä»¶ï¼š</label>
            <input type="file" id="attachments" multiple>
            <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
              æ”¯æŒå›¾ç‰‡ã€æ–‡æ¡£ã€éŸ³é¢‘æ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§25MB
            </div>
            <div id="fileList" style="margin-top: 10px;"></div>
          </div>
          
          <div class="progress-container" id="uploadProgress">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
          </div>
          
          <div class="button-group">
            <button type="submit" class="btn-primary" id="sendBtn">å‘é€é‚®ä»¶</button>
            <button type="button" class="btn-success" id="saveTemplateBtn">ä¿å­˜ä¸ºæ¨¡æ¿</button>
            <button type="button" class="btn-secondary" onclick="loadRecentEmails()">æŸ¥çœ‹æœ€è¿‘é‚®ä»¶</button>
          </div>
        </form>
        
        <div id="status" class="status"></div>
      </div>
      
      <div class="templates-section">
        <h2>é‚®ä»¶æ¨¡æ¿</h2>
        <div id="templatesList">
          <div class="no-templates">æš‚æ— æ¨¡æ¿ï¼Œè¯·å…ˆä¿å­˜ä¸€ä¸ªæ¨¡æ¿</div>
        </div>
        
        <h2 style="margin-top: 30px;">æœ€è¿‘é‚®ä»¶</h2>
        <div id="recentEmails" class="email-list">
          <div class="no-templates">ç‚¹å‡»"æŸ¥çœ‹æœ€è¿‘é‚®ä»¶"æŒ‰é’®åŠ è½½</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('é‚®ä»¶å‘é€å·¥å…·åˆå§‹åŒ–...');
      
      // æ£€æŸ¥è¿æ¥
      testConnection();
      
      // æ£€æŸ¥æˆæƒ
      checkAuth();
      
      // åŠ è½½æ¨¡æ¿
      loadTemplates();
      
      // è¡¨å•æäº¤
      document.getElementById('emailForm').addEventListener('submit', function(e) {
        e.preventDefault();
        sendEmail();
      });
      
      // ä¿å­˜æ¨¡æ¿
      document.getElementById('saveTemplateBtn').addEventListener('click', function() {
        const subject = document.getElementById('subject').value;
        const body = document.getElementById('body').value;
        
        if (!subject || !body) {
          showStatus('è¯·å¡«å†™ä¸»é¢˜å’Œå†…å®¹åå†ä¿å­˜æ¨¡æ¿', 'error');
          return;
        }
        
        const name = prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°ï¼š');
        if (name) {
          saveTemplate(name, subject, body);
        }
      });
      
      // æ–‡ä»¶ä¸Šä¼ ç›‘å¬
      document.getElementById('attachments').addEventListener('change', handleFileSelect);
    });
    
    // æµ‹è¯•è¿æ¥
    function testConnection() {
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('æœåŠ¡å™¨è¿æ¥æ­£å¸¸ï¼š', result);
        })
        .withFailureHandler(function(error) {
          console.error('è¿æ¥å¤±è´¥ï¼š', error);
          showStatus('æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        })
        .testConnection();
    }
    
    // æ£€æŸ¥æˆæƒ
    function checkAuth() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.authorized) {
            showAuthWarning(result);
          }
        })
        .withFailureHandler(function(error) {
          console.error('æˆæƒæ£€æŸ¥å¤±è´¥ï¼š', error);
        })
        .checkAuthorization();
    }
    
    // æ˜¾ç¤ºæˆæƒè­¦å‘Š
    function showAuthWarning(result) {
      const warningDiv = document.getElementById('authWarning');
      warningDiv.style.display = 'block';
      warningDiv.innerHTML = `
        <h3 style="margin-top: 0; color: #856404;">âš ï¸ éœ€è¦æˆæƒ</h3>
        <p>é‚®ä»¶å‘é€å·¥å…·éœ€è¦è®¿é—®æ‚¨çš„Google Driveæ¥å­˜å‚¨é™„ä»¶æ–‡ä»¶ã€‚</p>
        <p><strong>æˆæƒæ­¥éª¤ï¼š</strong></p>
        <ol>
          <li><a href="${result.authUrl}" target="_blank">ç‚¹å‡»è¿™é‡Œæ‰“å¼€æˆæƒé¡µé¢</a></li>
          <li>é€‰æ‹©æ‚¨çš„Googleè´¦æˆ·</li>
          <li>ç‚¹å‡»"å…è®¸"æŒ‰é’®æˆäºˆæƒé™</li>
          <li>è¿”å›æœ¬é¡µé¢å¹¶åˆ·æ–°</li>
        </ol>
        <p style="font-size: 12px; margin-top: 10px;">
          æ³¨æ„ï¼šå¦‚æœä¸æˆæƒï¼Œæ‚¨ä»ç„¶å¯ä»¥å‘é€é‚®ä»¶ï¼Œä½†æ— æ³•ä½¿ç”¨é™„ä»¶åŠŸèƒ½ã€‚
        </p>
      `;
    }
    
    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelect(event) {
      const files = event.target.files;
      const fileList = document.getElementById('fileList');
      
      if (files.length === 0) {
        fileList.innerHTML = '<div style="color: #6c757d; font-style: italic;">æ— é™„ä»¶</div>';
        return;
      }
      
      let html = '';
      let totalSize = 0;
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        totalSize += file.size;
        
        const fileSize = file.size > 1024 * 1024 
          ? (file.size / (1024 * 1024)).toFixed(2) + ' MB'
          : (file.size / 1024).toFixed(2) + ' KB';
        
        html += `
          <div class="file-item" id="file-${i}">
            <div>
              <strong>${file.name}</strong>
              <div style="font-size: 12px; color: #6c757d;">
                å¤§å°: ${fileSize} | ç±»å‹: ${file.type || 'æœªçŸ¥'}
              </div>
            </div>
            <button type="button" onclick="removeFile(${i})" style="
              background: #dc3545;
              color: white;
              border: none;
              border-radius: 4px;
              padding: 4px 8px;
              cursor: pointer;
              font-size: 12px;
            ">ç§»é™¤</button>
          </div>
        `;
      }
      
      // æ£€æŸ¥æ€»å¤§å°
      if (totalSize > 50 * 1024 * 1024) {
        showStatus('æ€»æ–‡ä»¶å¤§å°è¶…è¿‡50MBé™åˆ¶', 'error');
        event.target.value = '';
        fileList.innerHTML = '<div style="color: #6c757d; font-style: italic;">æ— é™„ä»¶</div>';
        return;
      }
      
      fileList.innerHTML = html;
    }
    
    // ç§»é™¤æ–‡ä»¶
    function removeFile(index) {
      const input = document.getElementById('attachments');
      const files = Array.from(input.files);
      
      if (index >= 0 && index < files.length) {
        files.splice(index, 1);
        
        const dataTransfer = new DataTransfer();
        files.forEach(file => dataTransfer.items.add(file));
        input.files = dataTransfer.files;
        
        const event = new Event('change');
        input.dispatchEvent(event);
      }
    }
    
    // å‘é€é‚®ä»¶
    function sendEmail() {
      const sendBtn = document.getElementById('sendBtn');
      const originalText = sendBtn.textContent;
      
      // éªŒè¯
      const recipient = document.getElementById('recipient').value;
      const subject = document.getElementById('subject').value;
      const body = document.getElementById('body').value;
      
      if (!recipient || !subject || !body) {
        showStatus('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
        return;
      }
      
      if (!isValidEmail(recipient)) {
        showStatus('æ”¶ä»¶äººé‚®ç®±æ ¼å¼ä¸æ­£ç¡®', 'error');
        return;
      }
      
      sendBtn.disabled = true;
      sendBtn.textContent = 'å‘é€ä¸­...';
      
      const filesInput = document.getElementById('attachments');
      const files = filesInput.files;
      
      // å¦‚æœæœ‰é™„ä»¶ï¼Œå…ˆä¸Šä¼ 
      if (files.length > 0) {
        uploadFiles(files).then(attachmentData => {
          sendEmailWithAttachments(recipient, subject, body, attachmentData, sendBtn, originalText);
        }).catch(error => {
          showStatus('é™„ä»¶ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
          sendBtn.disabled = false;
          sendBtn.textContent = originalText;
        });
      } else {
        sendEmailWithAttachments(recipient, subject, body, [], sendBtn, originalText);
      }
    }
    
    // ä¸Šä¼ æ–‡ä»¶
    function uploadFiles(files) {
      return new Promise((resolve, reject) => {
        const totalFiles = files.length;
        if (totalFiles === 0) {
          resolve([]);
          return;
        }
        
        const progressContainer = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        
        progressContainer.style.display = 'block';
        
        let uploadedCount = 0;
        const results = [];
        
        function uploadNext() {
          if (uploadedCount >= totalFiles) {
            progressContainer.style.display = 'none';
            resolve(results);
            return;
          }
          
          const file = files[uploadedCount];
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const base64Data = e.target.result.split(',')[1];
            
            google.script.run
              .withSuccessHandler(function(result) {
                if (result.success) {
                  results.push(result);
                }
                
                uploadedCount++;
                const progress = Math.round((uploadedCount / totalFiles) * 100);
                progressFill.style.width = progress + '%';
                progressText.textContent = progress + '%';
                
                uploadNext();
              })
              .withFailureHandler(function(error) {
                reject(error);
              })
              .uploadFileToDrive(file.name, base64Data, file.type);
          };
          
          reader.onerror = function() {
            reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
          };
          
          reader.readAsDataURL(file);
        }
        
        uploadNext();
      });
    }
    
    // å‘é€å¸¦é™„ä»¶çš„é‚®ä»¶
    function sendEmailWithAttachments(recipient, subject, body, attachmentData, sendBtn, originalText) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus(result.message, 'success');
            document.getElementById('emailForm').reset();
            document.getElementById('fileList').innerHTML = '<div style="color: #6c757d; font-style: italic;">æ— é™„ä»¶</div>';
          } else {
            showStatus(result.message, 'error');
          }
          sendBtn.disabled = false;
          sendBtn.textContent = originalText;
        })
        .withFailureHandler(function(error) {
          showStatus('å‘é€å¤±è´¥ï¼š' + error.message, 'error');
          sendBtn.disabled = false;
          sendBtn.textContent = originalText;
        })
        .sendCustomEmail(recipient, subject, body, '', '', attachmentData);
    }
    
    // æ¨¡æ¿åŠŸèƒ½
    function saveTemplate(name, subject, body) {
      google.script.run
        .withSuccessHandler(function(result) {
          showStatus(result.message, 'success');
          loadTemplates();
        })
        .withFailureHandler(function(error) {
          showStatus('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
        })
        .saveTemplate(name, subject, body);
    }
    
    function loadTemplates() {
      google.script.run
        .withSuccessHandler(function(templates) {
          const templatesList = document.getElementById('templatesList');
          
          if (templates.length === 0) {
            templatesList.innerHTML = '<div class="no-templates">æš‚æ— æ¨¡æ¿ï¼Œè¯·å…ˆä¿å­˜ä¸€ä¸ªæ¨¡æ¿</div>';
            return;
          }
          
          templatesList.innerHTML = templates.map((template, index) => `
            <div class="template-item">
              <div class="template-header">
                <span class="template-name">${template.name}</span>
                <div class="template-actions">
                  <button class="template-btn btn-secondary" onclick="useTemplate(${index})">ä½¿ç”¨</button>
                  <button class="template-btn btn-danger" onclick="deleteTemplate(${index})">åˆ é™¤</button>
                </div>
              </div>
              <div><strong>ä¸»é¢˜ï¼š</strong>${template.subject}</div>
              <div><strong>å†…å®¹ï¼š</strong>${template.body.substring(0, 100)}...</div>
              <div><small>åˆ›å»ºæ—¶é—´ï¼š${new Date(template.created).toLocaleDateString()}</small></div>
            </div>
          `).join('');
        })
        .getTemplates();
    }
    
    function useTemplate(index) {
      google.script.run
        .withSuccessHandler(function(templates) {
          if (templates[index]) {
            document.getElementById('subject').value = templates[index].subject;
            document.getElementById('body').value = templates[index].body;
            showStatus('æ¨¡æ¿å·²åŠ è½½', 'success');
          }
        })
        .getTemplates();
    }
    
    function deleteTemplate(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ')) {
        google.script.run
          .withSuccessHandler(function(result) {
            showStatus(result.message, 'success');
            loadTemplates();
          })
          .deleteTemplate(index);
      }
    }
    
    // åŠ è½½æœ€è¿‘é‚®ä»¶
    function loadRecentEmails() {
      google.script.run
        .withSuccessHandler(function(emails) {
          const recentEmails = document.getElementById('recentEmails');
          
          if (emails.length === 0) {
            recentEmails.innerHTML = '<div class="no-templates">æš‚æ— æœ€è¿‘é‚®ä»¶è®°å½•</div>';
            return;
          }
          
          recentEmails.innerHTML = emails.map(email => `
            <div class="email-item">
              <div><strong>æ”¶ä»¶äººï¼š</strong>${email.to}</div>
              <div><strong>ä¸»é¢˜ï¼š</strong>${email.subject}</div>
              <div><strong>æ—¶é—´ï¼š</strong>${new Date(email.date).toLocaleString()}</div>
              <div><strong>å†…å®¹é¢„è§ˆï¼š</strong>${email.body}</div>
            </div>
          `).join('');
        })
        .getRecentEmails(5);
    }
    
    // æ˜¾ç¤ºçŠ¶æ€
    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = 'status ' + type;
      statusDiv.style.display = 'block';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }
    
    // éªŒè¯é‚®ç®±
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }
  </script>
</body>
</html>